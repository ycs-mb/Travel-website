# Activity Diagrams & Workflow Visualization

---

## Complete Workflow Activity Diagram (Web Upload Flow)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Travel Photo Organization Workflow (via Web Application)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ START: User Access Web UI               â”‚
        â”‚ â€¢ Navigate to http://localhost:5001     â”‚
        â”‚ â€¢ Flask app serves index.html           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Upload: User Drags Photos               â”‚
        â”‚ â€¢ Select multiple images                â”‚
        â”‚ â€¢ Click "Upload and Process"            â”‚
        â”‚ â€¢ POST /upload with files               â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Flask: Save Uploaded Files              â”‚
        â”‚ â€¢ Create uploads/{timestamp}/           â”‚
        â”‚ â€¢ Save each file                        â”‚
        â”‚ â€¢ Return run_id to user                 â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Flask: Trigger Orchestrator             â”‚
        â”‚ â€¢ subprocess.Popen orchestrator.py      â”‚
        â”‚ â€¢ Run in background                     â”‚
        â”‚ â€¢ Status: "running"                     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Orchestrator: Initialization            â”‚
        â”‚ â€¢ Load config.yaml                      â”‚
        â”‚ â€¢ Setup ADC for Vertex AI               â”‚
        â”‚ â€¢ Create output/{timestamp}/            â”‚
        â”‚ â€¢ Initialize logger                     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Input: Load Image Files                 â”‚
        â”‚ â€¢ Scan uploads/{timestamp}/             â”‚
        â”‚ â€¢ Filter by format (JPG, PNG, HEIC)     â”‚
        â”‚ â€¢ Count total images                    â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ STAGE 1: METADATA EXTRACTION            â”‚
        â”‚ Agent 1                                 â”‚
        â”‚ â€¢ Extract EXIF data                     â”‚
        â”‚ â€¢ Parse GPS coordinates                 â”‚
        â”‚ â€¢ **Reverse geocode (GPS â†’ location)**  â”‚
        â”‚ â€¢ Read camera settings                  â”‚
        â”‚ â€¢ Identify problematic images           â”‚
        â”‚ ThreadPool: 4 workers                   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Validate Agent 1 Output                 â”‚
        â”‚ â€¢ Check schema compliance               â”‚
        â”‚ â€¢ Verify GPS + location field           â”‚
        â”‚ â€¢ Log any validation errors             â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ Validation OK?  â”‚
                â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                     â”‚       â”‚
                  Yesâ”‚       â”‚No
                     â”‚       â–¼
                     â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚   â”‚ Log Warning         â”‚
                     â”‚   â”‚ Continue with       â”‚
                     â”‚   â”‚ partial results     â”‚
                     â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚            â”‚
                     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                          â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ STAGE 2: PARALLEL ASSESSMENT            â”‚
        â”‚ Agents 2 & 3 Run Concurrently           â”‚
        â”‚                                         â”‚
        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
        â”‚ â”‚ Agent 2: Quality Assessment       â”‚   â”‚
        â”‚ â”‚ â€¢ Analyze sharpness (Laplacian)   â”‚   â”‚
        â”‚ â”‚ â€¢ Check exposure (histogram)      â”‚   â”‚
        â”‚ â”‚ â€¢ Detect noise (patch variance)   â”‚   â”‚
        â”‚ â”‚ â€¢ Score 1-5                       â”‚   â”‚
        â”‚ â”‚ ThreadPool: 2 workers (OpenCV)    â”‚   â”‚
        â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
        â”‚                 â”‚                       â”‚
        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
        â”‚ â”‚ Agent 3: Aesthetic Assessment     â”‚   â”‚
        â”‚ â”‚ â€¢ Call Vertex AI (Gemini)         â”‚   â”‚
        â”‚ â”‚ â€¢ Evaluate composition            â”‚   â”‚
        â”‚ â”‚ â€¢ Rate framing, lighting          â”‚   â”‚
        â”‚ â”‚ â€¢ **Extract token usage**         â”‚   â”‚
        â”‚ â”‚ â€¢ Score 1-5 (VLM API)             â”‚   â”‚
        â”‚ â”‚ ThreadPool: 2 workers             â”‚   â”‚
        â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
        â”‚                 â”‚                       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                    [Wait for both to complete]
                          â”‚
                          â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Validate Agents 2 & 3 Outputs           â”‚
        â”‚ â€¢ Check score ranges (1-5)              â”‚
        â”‚ â€¢ Verify token_usage structure          â”‚
        â”‚ â€¢ Verify all images processed           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ Validation OK?  â”‚
                â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                     â”‚       â”‚
                  Yesâ”‚       â”‚No
                     â”‚       â–¼
                     â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚   â”‚ Assign default      â”‚
                     â”‚   â”‚ scores to failed    â”‚
                     â”‚   â”‚ images              â”‚
                     â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚            â”‚
                     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                          â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ STAGE 3: FILTERING & CATEGORIZATION     â”‚
        â”‚ Agent 4                                 â”‚
        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
        â”‚ â”‚ â€¢ Apply quality thresholds         â”‚   â”‚
        â”‚ â”‚ â€¢ Call Vertex AI for categorizationâ”‚   â”‚
        â”‚ â”‚ â€¢ Categorize by content            â”‚   â”‚
        â”‚ â”‚ â€¢ Extract location from GPS        â”‚   â”‚
        â”‚ â”‚ â€¢ **Generate reasoning (why        â”‚   â”‚
        â”‚ â”‚   passed/rejected)**               â”‚   â”‚
        â”‚ â”‚ â€¢ **Extract token usage**          â”‚   â”‚
        â”‚ â”‚ ThreadPool: 2 workers              â”‚   â”‚
        â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Validate Agent 4 Output                 â”‚
        â”‚ â€¢ Check category values                 â”‚
        â”‚ â€¢ Verify reasoning field exists         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ Validation OK?  â”‚
                â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                     â”‚       â”‚
                  Yesâ”‚       â”‚No
                     â”‚       â–¼
                     â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚   â”‚ Use fallback        â”‚
                     â”‚   â”‚ values              â”‚
                     â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚            â”‚
                     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                          â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ STAGE 4: CAPTION GENERATION             â”‚
        â”‚ Agent 5                                 â”‚
        â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
        â”‚ â”‚ â€¢ Build comprehensive context      â”‚   â”‚
        â”‚ â”‚   from all upstream agents         â”‚   â”‚
        â”‚ â”‚ â€¢ Call Vertex AI                   â”‚   â”‚
        â”‚ â”‚ â€¢ Generate concise caption         â”‚   â”‚
        â”‚ â”‚ â€¢ Write standard caption           â”‚   â”‚
        â”‚ â”‚ â€¢ Extract keywords                 â”‚   â”‚
        â”‚ â”‚ â€¢ **Extract token usage**          â”‚   â”‚
        â”‚ â”‚ ThreadPool: 2 workers              â”‚   â”‚
        â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ Validate Agent 5 Output                 â”‚
        â”‚ â€¢ Verify caption lengths                â”‚
        â”‚ â€¢ Validate keyword format               â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚ Validation OK?  â”‚
                â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
                     â”‚       â”‚
                  Yesâ”‚       â”‚No
                     â”‚       â–¼
                     â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                     â”‚   â”‚ Use fallback        â”‚
                     â”‚   â”‚ values              â”‚
                     â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚            â”‚
                     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                          â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ STAGE 5: REPORTING & ANALYSIS           â”‚
        â”‚ â€¢ Aggregate all validations             â”‚
        â”‚ â€¢ Calculate statistics                  â”‚
        â”‚ â€¢ **Calculate total token usage**       â”‚
        â”‚ â€¢ Generate final_report.json            â”‚
        â”‚ â€¢ Create error registry                 â”‚
        â”‚ â€¢ Calculate execution time              â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ OUTPUT: Save All Results                â”‚
        â”‚ â€¢ Write agent reports to                â”‚
        â”‚   output/{timestamp}/reports/           â”‚
        â”‚ â€¢ Save logs to logs/                    â”‚
        â”‚ â€¢ Write final report                    â”‚
        â”‚ â€¢ Copy processed images                 â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ SUCCESS: Workflow Complete              â”‚
        â”‚ â€¢ Status file updated                   â”‚
        â”‚ â€¢ Web UI can display results            â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         â”‚
                         â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚ User: View Report                       â”‚
        â”‚ â€¢ Click run in dashboard                â”‚
        â”‚ â€¢ Flask loads all agent outputs         â”‚
        â”‚ â€¢ Serves report.html with tabs          â”‚
        â”‚ â€¢ Display token usage per agent         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Agent Execution Timeline (With Token Tracking)

```
Timeline: Parallel Execution of 150 Images

Time (minutes)
0        â”‚
         â”‚  Agent 1: Metadata Extraction
         â”‚  [4 workers, I/O + Geocoding API]  ~2 min
         â”‚  Output: GPS coordinates + location names
         â”‚
2        â”‚
         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  â”‚ Agent 2: Quality                 â”‚
         â”‚  â”‚ [2 workers, CPU - OpenCV]        â”‚
         â”‚  â”‚ ~3 min                           â”‚
         â”‚  â”‚ Output: Technical scores         â”‚
         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                  â•‘
         â”‚                  â•‘ Parallel
         â”‚                  â•‘
         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  â”‚ Agent 3: Aesthetic               â”‚
         â”‚  â”‚ [2 workers, Vertex AI]           â”‚
         â”‚  â”‚ ~5 min                           â”‚
         â”‚  â”‚ Output: Artistic scores + tokens â”‚
         â”‚  â”‚ Token usage: ~500-1000 per image â”‚
         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
7        â”‚
         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  â”‚ Agent 4: Filtering               â”‚
         â”‚  â”‚ [2 workers, Vertex AI + Rules]   â”‚
         â”‚  â”‚ ~2 min                           â”‚
         â”‚  â”‚ Output: Categories + reasoning   â”‚
         â”‚  â”‚ Token usage: ~300-600 per image  â”‚
         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
9        â”‚
         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  â”‚ Agent 5: Captions                â”‚
         â”‚  â”‚ [2 workers, Vertex AI]           â”‚
         â”‚  â”‚ ~3 min                           â”‚
         â”‚  â”‚ Output: Multi-level captions     â”‚
         â”‚  â”‚ Token usage: ~600-1200 per image â”‚
         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
12       â”‚
         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚  â”‚ Final Reporting & Save           â”‚
         â”‚  â”‚ â€¢ Aggregate token usage          â”‚
         â”‚  â”‚ â€¢ Total: ~200K-400K tokens       â”‚
         â”‚  â”‚ â€¢ Generate statistics            â”‚
         â”‚  â”‚ ~1 min                           â”‚
         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
13       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

Total Estimated Time: ~12-13 minutes for 150 images
Total Token Usage: ~200,000-400,000 tokens
(with parallel optimization + Vertex AI calls)
```

---

## Single Image Processing Flow (Enhanced)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Processing One Image Through All Stages          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Image Input: photo.jpg (uploaded via web UI)
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Agent 1: Metadata              â”‚
â”‚ extract_exif() â”€â†’              â”‚
â”‚ parse_gps() â”€â†’                 â”‚
â”‚ reverse_geocode() â”€â†’ LOCATION  â”‚
â”‚ read_camera_settings() â”€â†’      â”‚
â”‚ validate_output() â”€â†’           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
    Metadata Output
    {
      image_id, filename,
      gps: {
        lat: 49.398750,
        lon: 8.672434,
        location: "Heidelberg, Germany"
      },
      camera_settings,
      capture_datetime
    }
         â”‚
         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚              â”‚              â”‚
         â–¼              â–¼              â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
    â”‚   Agent 2   â”‚ â”‚  Agent 3   â”‚    â”‚
    â”‚   Quality   â”‚ â”‚ Aesthetic  â”‚    â”‚
    â”‚   OpenCV    â”‚ â”‚ Vertex AI  â”‚    â”‚
    â”‚   â†“         â”‚ â”‚    â†“       â”‚    â”‚
    â”‚ Quality:    â”‚ â”‚ Aesthetic: â”‚    â”‚
    â”‚  Score: 4   â”‚ â”‚  Score: 4  â”‚    â”‚
    â”‚  Sharp: 4   â”‚ â”‚  Comp: 5   â”‚    â”‚
    â”‚  Noise: 3   â”‚ â”‚  Light: 5  â”‚    â”‚
    â”‚  Exp: 5     â”‚ â”‚  Notes: .. â”‚    â”‚
    â”‚             â”‚ â”‚  Tokens:   â”‚    â”‚
    â”‚             â”‚ â”‚  {tot: 789}â”‚    â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â”‚
           â”‚              â”‚           â”‚
           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
                  â–¼                   â”‚
         Quality & Aesthetic Data    â”‚
                  â”‚                   â”‚
                  â”‚ (combined)        â”‚
                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚   Agent 4: Filtering â”‚
                 â”‚   Vertex AI + Rules  â”‚
                 â”‚                      â”‚
                 â”‚ Categorize:          â”‚
                 â”‚ â”œâ”€ Landscape         â”‚
                 â”‚ â”œâ”€ Golden Hour       â”‚
                 â”‚ â”œâ”€ Location: Germany â”‚
                 â”‚ â””â”€ Pass filter? YES  â”‚
                 â”‚                      â”‚
                 â”‚ Reasoning:           â”‚
                 â”‚ "Passed. Quality 4/3,â”‚
                 â”‚  Aesthetic 4/3"      â”‚
                 â”‚                      â”‚
                 â”‚ Tokens: {tot: 456}   â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚   Agent 5: Captions  â”‚
                 â”‚   Vertex AI          â”‚
                 â”‚                      â”‚
                 â”‚ Context from all:    â”‚
                 â”‚ â€¢ Location: Germany  â”‚
                 â”‚ â€¢ Category: Landscapeâ”‚
                 â”‚ â€¢ Time: Golden Hour  â”‚
                 â”‚ â€¢ Quality: 4/5       â”‚
                 â”‚ â€¢ Aesthetic: 4/5     â”‚
                 â”‚                      â”‚
                 â”‚ Generate:            â”‚
                 â”‚ â”œâ”€ Concise: "..."    â”‚
                 â”‚ â”œâ”€ Standard: "..."   â”‚
                 â”‚ â”œâ”€ Keywords: [...]   â”‚
                 â”‚ â””â”€ Tokens: {tot:1024}â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
            Full Image Record
            {
              all metadata,
              all scores,
              all agent outputs,
              total_tokens: 2269
            }
                            â”‚
                            â–¼
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚   Web UI Display     â”‚
                 â”‚   Tabbed Interface   â”‚
                 â”‚                      â”‚
                 â”‚ Tabs:                â”‚
                 â”‚ â€¢ Metadata (w/loc)   â”‚
                 â”‚ â€¢ Quality            â”‚
                 â”‚ â€¢ Aesthetic (w/toks) â”‚
                 â”‚ â€¢ Filtering (w/reas) â”‚
                 â”‚ â€¢ Caption (w/toks)   â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Error Recovery Flow (Enhanced)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Agent Processing with Error Handling â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Load image file â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ BEGIN TRY BLOCK    â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Process Image                 â”‚
    â”‚ â€¢ Extract data/features        â”‚
    â”‚ â€¢ Call Vertex AI (if VLM)      â”‚
    â”‚ â€¢ Compute metrics              â”‚
    â”‚ â€¢ **Extract token usage**      â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Validate Output                â”‚
    â”‚ â€¢ Check schema                 â”‚
    â”‚ â€¢ Verify ranges                â”‚
    â”‚ â€¢ Ensure required fields       â”‚
    â”‚ â€¢ Validate token_usage struct  â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Success?                       â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚          â”‚
      YESâ”‚          â”‚NO
         â”‚          â–¼
         â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚    â”‚ EXCEPTION CAUGHT     â”‚
         â”‚    â”‚ Caught exceptions:    â”‚
         â”‚    â”‚ â€¢ APIError (Vertex)   â”‚
         â”‚    â”‚ â€¢ GeocodingError      â”‚
         â”‚    â”‚ â€¢ FileNotFoundError   â”‚
         â”‚    â”‚ â€¢ ValidationError     â”‚
         â”‚    â”‚ â€¢ ProcessingError     â”‚
         â”‚    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚         â”‚
         â”‚    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚    â”‚ Categorize Error      â”‚
         â”‚    â”‚ Determine severity:    â”‚
         â”‚    â”‚ â€¢ info/warning/error  â”‚
         â”‚    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚         â”‚
         â”‚    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚    â”‚ Log Error             â”‚
         â”‚    â”‚ â†’ ERROR_LOG global    â”‚
         â”‚    â”‚ â†’ workflow.log        â”‚
         â”‚    â”‚ â†’ errors.json         â”‚
         â”‚    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚         â”‚
         â”‚    â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚    â”‚ Create Default Result â”‚
         â”‚    â”‚ with error flag       â”‚
         â”‚    â”‚ (no token usage)      â”‚
         â”‚    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚         â”‚
         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜
              â”‚
         â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Return Result             â”‚
         â”‚ (success or placeholder)  â”‚
         â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â”‚
         â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚ Continue to Next Image    â”‚
         â”‚ (if continue_on_error)    â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Error Handling Strategy:
â€¢ Try to process every image
â€¢ Log errors with context
â€¢ Assign default results on failure
â€¢ Mark images with error flags
â€¢ Collect all errors for final report
â€¢ Track token usage even for errors (if available)
```

---

## Web Application Request Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ User Interaction with Web UI         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚
           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Browser         â”‚
    â”‚ localhost:5001  â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ GET /
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Flask: index()  â”‚
    â”‚ â€¢ Get all runs  â”‚
    â”‚ â€¢ Render index  â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼ HTML (dashboard)
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ User drags photos       â”‚
    â”‚ Clicks "Upload"         â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ POST /upload + files
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Flask: upload()         â”‚
    â”‚ â€¢ Save to uploads/      â”‚
    â”‚ â€¢ Create timestamp      â”‚
    â”‚ â€¢ Trigger orchestrator  â”‚
    â”‚ â€¢ Return run_id         â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼ JSON {run_id, status: "running"}
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Browser: Poll status    â”‚
    â”‚ setInterval(3000)       â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ GET /status/<run_id>
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Flask: check_status()   â”‚
    â”‚ â€¢ Check if complete     â”‚
    â”‚ â€¢ Return status         â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼ JSON {status: "completed"}
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Browser: Navigate to    â”‚
    â”‚ /report/<timestamp>     â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ GET /report/<timestamp>
         â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Flask: view_report()            â”‚
    â”‚ â€¢ Load metadata JSON            â”‚
    â”‚ â€¢ Load quality JSON             â”‚
    â”‚ â€¢ Load aesthetic JSON (+tokens) â”‚
    â”‚ â€¢ Load filtering JSON (+tokens) â”‚
    â”‚ â€¢ Load caption JSON (+tokens)   â”‚
    â”‚ â€¢ Merge by image_id             â”‚
    â”‚ â€¢ Render report.html            â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼ HTML (tabbed report)
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Browser: Interactive Report     â”‚
    â”‚ â€¢ Image grid                    â”‚
    â”‚ â€¢ Per-image tabs:               â”‚
    â”‚   - Metadata                    â”‚
    â”‚   - Quality                     â”‚
    â”‚   - Aesthetic (+ token usage)   â”‚
    â”‚   - Filtering (+ token usage)   â”‚
    â”‚   - Caption (+ token usage)     â”‚
    â”‚ â€¢ JavaScript tab switching      â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Configuration Decision Tree (Updated)

```
START: Load Configuration
    â”‚
    â”œâ”€ config.yaml exists?
    â”‚  â”œâ”€ YES: Parse YAML
    â”‚  â”‚       â”‚
    â”‚  â”‚       â”œâ”€ Validate schema
    â”‚  â”‚       â”‚  â”œâ”€ VALID: Proceed
    â”‚  â”‚       â”‚  â””â”€ INVALID: Log error, use defaults
    â”‚  â”‚
    â”‚  â””â”€ NO: Use default config
    â”‚
    â”œâ”€ Vertex AI credentials?
    â”‚  â”œâ”€ ADC configured?
    â”‚  â”‚  â”œâ”€ YES: gcloud auth application-default login
    â”‚  â”‚  â”‚       â”œâ”€ Check vertex_ai.project set
    â”‚  â”‚  â”‚       â”‚  â”œâ”€ YES: Enable Agents 3, 4, 5
    â”‚  â”‚  â”‚       â”‚  â””â”€ NO: Error, cannot use VLM agents
    â”‚  â”‚  â”‚
    â”‚  â”‚  â””â”€ NO: Check GOOGLE_APPLICATION_CREDENTIALS
    â”‚  â”‚          â”œâ”€ YES: Enable Agents 3, 4, 5
    â”‚  â”‚          â””â”€ NO: Error, cannot use VLM agents
    â”‚  â”‚
    â”‚  â””â”€ GOOGLE_API_KEY set? (deprecated)
    â”‚     â””â”€ NO: Vertex AI only
    â”‚
    â”œâ”€ Geocoding available?
    â”‚  â”œâ”€ Nominatim accessible?
    â”‚  â”‚  â”œâ”€ YES: Enable reverse geocoding
    â”‚  â”‚  â””â”€ NO: Log warning, GPS coords only
    â”‚  â”‚
    â”‚  â””â”€ Continue without if unavailable
    â”‚
    â”œâ”€ input_images or uploads/ exists?
    â”‚  â”œâ”€ YES: Scan for images
    â”‚  â”‚       â”‚
    â”‚  â”‚       â”œâ”€ Images found? â”€â”€â†’ Continue
    â”‚  â”‚       â””â”€ No images? â”€â”€â”€â”€â†’ Exit with error
    â”‚  â”‚
    â”‚  â””â”€ NO: Create directory, wait for upload
    â”‚
    â””â”€ Create output directories
       â”œâ”€ output/{timestamp}/
       â”œâ”€ output/{timestamp}/reports/
       â”œâ”€ output/{timestamp}/logs/
       â””â”€ READY: Start workflow
```

---

## Data Aggregation Flow (Enhanced)

```
Individual Agent Outputs          Final Aggregation
    â”‚                                    â–²
    â”œâ”€ Agent 1: metadata_extraction      â”‚
    â”‚  â””â”€ List[Dict] 150 items           â”‚
    â”‚     {gps: {location: "..."}}  â”€â”   â”‚
    â”‚                                â”‚   â”‚
    â”œâ”€ Agent 2: quality_assessment   â”‚   â”‚
    â”‚  â””â”€ List[Dict] 150 items â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”¼â”€ Merge on image_id
    â”‚     {quality_score, ...}       â”‚   â”‚
    â”‚                                â”‚   â”‚
    â”œâ”€ Agent 3: aesthetic_assessment â”‚   â”‚
    â”‚  â””â”€ List[Dict] 150 items â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”¼â”€ Preserve all fields
    â”‚     {overall_aesthetic, ...    â”‚   â”‚
    â”‚      token_usage: {...}}       â”‚   â”‚
    â”‚                                â”‚   â”‚
    â”œâ”€ Agent 4: filtering_categorization â”‚
    â”‚  â””â”€ List[Dict] 150 items â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”¼â”€ Include token_usage
    â”‚     {category, reasoning, ...  â”‚   â”‚
    â”‚      token_usage: {...}}       â”‚   â”‚
    â”‚                                â”‚   â”‚
    â””â”€ Agent 5: caption_generation   â”‚   â”‚
       â””â”€ List[Dict] 150 items â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”¼â”€ Include token_usage
          {captions, keywords, ...   â”‚   â”‚
           token_usage: {...}} â”€â”€â”€â”€â”€â”€â”˜   â”‚
                                         â–¼
                                  Unified Report:
                                  â€¢ All 150 images
                                  â€¢ All agent outputs
                                  â€¢ Token usage per VLM call
                                  â€¢ Total tokens used
                                  â€¢ Complete metadata
                                  â€¢ Statistics
                                  â€¢ Error registry
                                         â”‚
                                         â–¼
                                  Web UI Display:
                                  â€¢ Tabbed interface
                                  â€¢ Token usage visible
                                  â€¢ Interactive exploration
```

---

## Token Usage Aggregation Flow

```
VLM Agents (3, 4, 5) Processing
    â”‚
    â”œâ”€ Agent 3: Aesthetic Assessment
    â”‚  â””â”€ For each image:
    â”‚     â”œâ”€ Call Vertex AI
    â”‚     â”œâ”€ Get response.usage_metadata
    â”‚     â”œâ”€ Extract tokens
    â”‚     â””â”€ Store in output
    â”‚        {token_usage: {
    â”‚          prompt_token_count: 312,
    â”‚          candidates_token_count: 89,
    â”‚          total_token_count: 401
    â”‚        }}
    â”‚
    â”œâ”€ Agent 4: Filtering
    â”‚  â””â”€ For each image:
    â”‚     â”œâ”€ Call Vertex AI
    â”‚     â”œâ”€ Extract tokens
    â”‚     â””â”€ Store: {total_token_count: 256}
    â”‚
    â””â”€ Agent 5: Captions
       â””â”€ For each image:
          â”œâ”€ Call Vertex AI
          â”œâ”€ Extract tokens
          â””â”€ Store: {total_token_count: 765}
                â”‚
                â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                â”‚                  â”‚
                â–¼                  â–¼
         Save to JSON        Aggregate in
         per agent           final_report
                â”‚                  â”‚
                â–¼                  â–¼
         Agent output       total_tokens_used:
         files with         sum(all token_usage
         token_usage        .total_token_count)
                â”‚                  â”‚
                â–¼                  â–¼
         Load in Flask      Display in
         for report         Web UI tabs
```

---

## Logging & Observability Flow (Enhanced)

```
All Agents During Execution
    â”‚
    â”œâ”€ INFO: Processing events
    â”‚  â””â”€ log_info(...) â†’ ğŸ“ workflow.log
    â”‚     "Processing image_001.jpg"
    â”‚     "Agent 3: Aesthetic score 4/5, tokens: 401"
    â”‚
    â”œâ”€ WARNING: Continue-on-error cases
    â”‚  â””â”€ log_warning(...) â†’ ğŸ“ workflow.log
    â”‚                       â†’ ğŸ”´ ERROR_LOG global
    â”‚     "Geocoding failed, using coordinates only"
    â”‚
    â”œâ”€ ERROR: Single image failures
    â”‚  â””â”€ log_error(...) â†’ ğŸ“ workflow.log
    â”‚                    â†’ ğŸ”´ ERROR_LOG global
    â”‚                    â†’ ğŸ“‹ errors.json
    â”‚     "Vertex AI API timeout for image_042.jpg"
    â”‚
    â””â”€ CRITICAL: Workflow stoppers
       â””â”€ log_critical(...) â†’ ğŸ“ workflow.log
                            â†’ ğŸ”´ ERROR_LOG global
                            â†’ ğŸ›‘ Exit
          "Vertex AI credentials not found"

Token Usage Logging:
    â”‚
    â”œâ”€ Per Image: In agent output JSON
    â”‚  {token_usage: {total_token_count: 401}}
    â”‚
    â”œâ”€ Per Agent: Sum in validation summary
    â”‚  "Agent 3: 150 images, 60,150 total tokens"
    â”‚
    â””â”€ Total: In final_report.json
       "total_tokens_used": 185,430

Error Registry (accumulated):
    â”‚
    â””â”€ ERROR_LOG = [
         {timestamp, agent, error_type, summary, severity, details},
         {timestamp, agent, error_type, summary, severity, details},
         ...
       ]

Final Reporting:
    â”‚
    â”œâ”€ output/{timestamp}/logs/workflow.log â† All structured logs
    â”œâ”€ output/{timestamp}/logs/errors.json â† Error registry (JSON)
    â”œâ”€ output/{timestamp}/reports/validations.json â† per-agent summaries
    â””â”€ output/{timestamp}/reports/final_report.json â† Stats + tokens + errors
```

---

**For high-level overview, see [HLD.md](./HLD.md)**
**For detailed specifications, see [LLD.md](./LLD.md)**
**For architecture diagrams, see [UML_DIAGRAMS.md](./UML_DIAGRAMS.md)**
**For quick setup, see [QUICKSTART.md](./QUICKSTART.md)**
